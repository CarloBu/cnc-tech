---
import { getCollection } from 'astro:content';
import Card from '@/components/Card.astro';
import Layout from '@/layouts/Layout.astro';
import ScrollIndicator from '@/components/ScrollIndicator.astro';
import LottieLayer from '@/components/LottieLayer.astro';

const allCards = await getCollection('cardsCollection');

const missionCard = allCards.find((card) => card.id === 'mission');
const trainingCard = allCards.find((card) => card.id === 'training');
const liveCard = allCards.find((card) => card.id === 'live');
---

<Layout title='CNC'>
	<div id='preloader-overlay' class='preloader-overlay' aria-hidden='true'>
		<div id='preloader-counter' class='preloader-counter'>0%</div>
	</div>
	<div class='loader-wrapper'>
		<LottieLayer id='loader-layer' src='/lottie/loader.json' removeAfterPlay />
	</div>
	<ScrollIndicator />

	<!-- CNC Logo -->
	<div class='logo-container'>
		<img id='cnc-logo' src='/cncLogo.svg' alt='CNC Logo' class='logo' />
	</div>

	{
		missionCard && (
			<div class='card-position card-position--left-middle' id='card-mission'>
				<Card content={missionCard} imagePosition='bottom' />
			</div>
		)
	}

	{
		trainingCard && (
			<div class='card-position card-position--right-bottom' id='card-training'>
				<Card content={trainingCard} imagePosition='right' />
			</div>
		)
	}

	{
		liveCard && (
			<div class='card-position card-position--right-middle' id='card-live'>
				<Card content={liveCard} size='large' imagePosition='right' />
			</div>
		)
	}

	<div class='scroll-section'></div>
	<canvas id='canvas'></canvas>
	<div class='bg-overlay-wrapper'>
		<LottieLayer id='bg-main' src='/lottie/bgMain.json' segments={[120, 149]} fillScreen />
		<LottieLayer id='bg-inner-circle' src='/lottie/bgInnerCircle.json' rotate='clockwise' rotationSpeed={60} />
		<LottieLayer id='bg-outer-circle' src='/lottie/bgOuterCircle.json' rotate='counter-clockwise' rotationSpeed={60} />
		<LottieLayer id='bg-static-circle' src='/lottie/bgStaticCircle.json' />
		<LottieLayer id='bg-cnc-letters' src='/lottie/bgCncLetters.json' />
	</div>

	<script src='@/scripts/threejs.js'></script>
	<script>
		import lottie from 'lottie-web';
		import { initializeCardsReveal } from '@/scripts/cardsRevealManager.js';
		import { initGlobalGsapAnimations } from '@/scripts/globalGsapAnimations.js';
		import { initializeCardAnimators } from '@/scripts/gsapCardReveal.js';
		import { createCustomScrollbar } from '@/scripts/customScrollbar.js';
		import { triggerPreloaderExit } from '@/scripts/preloader.js';
		declare global {
			interface Window {
				lenisManager: any;
				lottie: any;
			}
		}

		window.lottie = lottie;

		// Prevent browser scroll restoration and reset scroll position immediately
		if ('scrollRestoration' in history) {
			history.scrollRestoration = 'manual';
		}
		window.scrollTo(0, 0);

		document.addEventListener('DOMContentLoaded', () => {
			window.scrollTo(0, 0);

			// Trigger preloader exit animation
			triggerPreloaderExit();

			setTimeout(() => {
				if (window.lenisManager) {
					window.lenisManager.scrollToTop();

					initGlobalGsapAnimations(window.lenisManager);

					const cardsAPI = initializeCardsReveal(window.lenisManager);
					createCustomScrollbar(window.lenisManager);
				}
			}, 100);
		});

		window.addEventListener('pageshow', (event) => {
			window.scrollTo(0, 0);
			if (window.lenisManager) {
				window.lenisManager.scrollToTop();
			}
		});
	</script>
</Layout>
